<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Générateur de facture</title>
  <style>
    :root{
      --accent:#467FF7;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f4f6fb;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#111}
    .container{max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:380px 1fr;gap:20px}
    .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    h2{margin:0 0 12px;font-size:18px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input[type="text"],input[type="number"],input[type="date"],textarea,select{
      width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;
    }
    textarea{min-height:70px;resize:vertical}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .line-items{margin-top:12px;border-radius:8px;overflow:hidden}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #f0f2f7;text-align:left}
    th{background:#fbfcff;font-weight:700;color:#2b2b2b}
    .text-right{text-align:right}
    .invoice-preview{padding:24px}
    .invoice-card{background:#fff;padding:24px;border-radius:10px;box-shadow:0 8px 30px rgba(12,15,30,0.06)}
    .flex{display:flex;gap:12px;align-items:center}
    .spacer{flex:1}
    .logo{height:60px;object-fit:contain}
    .small{font-size:13px;color:var(--muted)}
    .totals{margin-top:14px}
    .totals-row{display:flex;justify-content:space-between;padding:6px 0}
    .actions{margin-top:12px;display:flex;gap:8px;align-items:center}
    .danger{background:#ff5c5c}
    .hidden{display:none}
    @media (max-width:980px){.container{grid-template-columns:1fr;padding:12px}}
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL - INPUTS -->
    <div class="panel">
      <h2>Paramètres de la facture</h2>

      <label>Nom de l'entreprise</label>
      <input id="bizName" type="text" value="Ma Société SARL"/>

      <label>Adresse de l'entreprise</label>
      <textarea id="bizAddress">123 Rue Exemple, Rabat, Maroc</textarea>

      <label>Téléphone / e-mail de l'entreprise</label>
      <input id="bizContact" type="text" value="info@company.test - +212 6 12 34 56 78"/>

      <label>Téléverser un logo (optionnel)</label>
      <input id="logoInput" type="file" accept="image/*"/>
      <div class="small muted">Formats PNG / JPG recommandés. Affiché dans l'en-tête de la facture.</div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #f0f2f7"/>

      <label>Nom du client</label>
      <input id="clientName" type="text" value="Nom du client"/>

      <label>Adresse du client</label>
      <textarea id="clientAddress">Adresse du client</textarea>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>N° de facture</label>
          <input id="invoiceNumber" type="text" value="FAC-2025-001"/>
        </div>
        <div style="width:150px">
          <label>Date</label>
          <input id="invoiceDate" type="date" value="" />
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #f0f2f7"/>

      <h3 class="small" style="margin:8px 0 6px">Lignes de facture</h3>
      <div class="line-items panel" style="padding:0">
        <table id="itemsTable">
          <thead><tr>
            <th style="width:28%">Article</th>
            <th style="width:32%">Description détaillée</th>
            <th style="width:10%">Qté</th>
            <th style="width:16%">Prix unitaire</th>
            <th style="width:10%">Total</th>
            <th style="width:4%"></th>
          </tr></thead>
          <tbody id="itemsBody">
            <!-- rows inserted here -->
          </tbody>
        </table>
      </div>
      <div style="margin-top:8px">
        <button id="addItemBtn" class="btn">+ Ajouter une ligne</button>
      </div>

      <label style="margin-top:12px">TVA (%)</label>
      <input id="taxPct" type="number" value="20" min="0"/>

      <label>Remise (montant fixe)</label>
      <input id="discount" type="number" value="0" min="0"/>

      <div class="actions">
        <button id="generateBtn" class="btn">Générer le PDF</button>
        <button id="previewBtn" class="btn" style="background:#0ea5a2">Actualiser l'aperçu</button>
        <button id="clearBtn" class="btn danger">Effacer</button>
      </div>

      <div style="margin-top:12px" class="small muted">
        Astuce : ajoutez vos lignes, renseignez la TVA et la remise, puis cliquez sur « Générer le PDF ». L’aperçu de la facture se met à jour automatiquement lorsque vous modifiez les champs.
      </div>
    </div>

    <!-- RIGHT PANEL - PREVIEW -->
    <div class="panel invoice-preview">
      <div class="invoice-card" id="invoiceArea">
        <div class="flex">
          <div>
            <img id="logoPreview" class="logo hidden" alt="logo" />
            <div style="margin-top:8px">
              <div id="bizNamePreview" style="font-weight:700;font-size:18px">Ma Société SARL</div>
              <div id="bizAddressPreview" class="small">123 Rue Exemple, Rabat, Maroc</div>
              <div id="bizContactPreview" class="small">info@company.test</div>
            </div>
          </div>
          <div class="spacer"></div>
          <div style="text-align:right">
            <div style="font-weight:700">FACTURE</div>
            <div class="small">N° <span id="invNumberPreview">FAC-2025-001</span></div>
            <div class="small">Date : <span id="invDatePreview"></span></div>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #f0f2f7"/>

        <div style="display:flex;gap:20px">
          <div style="flex:1">
            <div class="small">FACTURER À</div>
            <div id="clientNamePreview" style="font-weight:600">Nom du client</div>
            <div id="clientAddressPreview" class="small">Adresse du client</div>
          </div>
          <div style="width:200px;text-align:right">
            <div class="small">Conditions de paiement</div>
            <div class="small">Payable à réception</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <table id="previewItems">
            <thead>
              <tr><th style="width:56%">Description</th><th>Qté</th><th>PU</th><th class="text-right">Montant</th></tr>
            </thead>
            <tbody id="previewItemsBody"></tbody>
          </table>
        </div>

        <div class="totals" id="totalsArea">
          <!-- totals injected here -->
        </div>

        <div style="margin-top:12px" class="small muted">Merci pour votre confiance. Paiement par virement ou chèque.</div>
      </div>
    </div>
  </div>

<script>
  // Simple invoice generator logic
  const itemsBody = document.getElementById('itemsBody');
  const previewItemsBody = document.getElementById('previewItemsBody');
  const addItemBtn = document.getElementById('addItemBtn');
  const generateBtn = document.getElementById('generateBtn');
  const previewBtn = document.getElementById('previewBtn');
  const clearBtn = document.getElementById('clearBtn');

  // Inputs to mirror
  const bizName = document.getElementById('bizName');
  const bizAddress = document.getElementById('bizAddress');
  const bizContact = document.getElementById('bizContact');
  const clientName = document.getElementById('clientName');
  const clientAddress = document.getElementById('clientAddress');
  const invoiceNumber = document.getElementById('invoiceNumber');
  const invoiceDate = document.getElementById('invoiceDate');
  const taxPct = document.getElementById('taxPct');
  const discount = document.getElementById('discount');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');

  // preview elements
  const bizNamePreview = document.getElementById('bizNamePreview');
  const bizAddressPreview = document.getElementById('bizAddressPreview');
  const bizContactPreview = document.getElementById('bizContactPreview');
  const clientNamePreview = document.getElementById('clientNamePreview');
  const clientAddressPreview = document.getElementById('clientAddressPreview');
  const invNumberPreview = document.getElementById('invNumberPreview');
  const invDatePreview = document.getElementById('invDatePreview');
  const totalsArea = document.getElementById('totalsArea');
  const invoiceArea = document.getElementById('invoiceArea');

  // default date to today
  (function setToday(){
    const today = new Date().toISOString().slice(0,10);
    invoiceDate.value = today;
  })();

  // Utility to format money
  function fmt(n){
    const formatted = Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    return formatted;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // create default item (avec description détaillée)
  function addItem(desc='Libellé du service', notes='', qty=1, unit=0){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="item-desc" type="text" value="${escapeHtml(desc)}" /></td>
      <td><input class="item-notes" type="text" value="${escapeHtml(notes)}" placeholder="Description détaillée (optionnelle)" /></td>
      <td><input class="item-qty" type="number" value="${qty}" min="0" /></td>
      <td><input class="item-unit" type="number" value="${unit}" min="0" step="0.01" /></td>
      <td class="text-right item-total">${fmt(qty*unit)}</td>
      <td style="text-align:center"><button class="removeBtn" title="Supprimer la ligne" style="background:#fff;border:0;color:#ff5c5c;cursor:pointer">✕</button></td>
    `;
    itemsBody.appendChild(tr);

    bindRowEvents(tr);
    refreshPreview();
  }

  function bindRowEvents(tr){
    const desc = tr.querySelector('.item-desc');
    const notes = tr.querySelector('.item-notes');
    const qty = tr.querySelector('.item-qty');
    const unit = tr.querySelector('.item-unit');
    const totalCell = tr.querySelector('.item-total');
    const removeBtn = tr.querySelector('.removeBtn');

    function updateRow(){
      const q = Number(qty.value||0);
      const u = Number(unit.value||0);
      totalCell.textContent = fmt(q*u);
      refreshPreview();
    }
    desc.addEventListener('input', refreshPreview);
    if(notes){ notes.addEventListener('input', refreshPreview); }
    qty.addEventListener('input', updateRow);
    unit.addEventListener('input', updateRow);
    removeBtn.addEventListener('click', ()=>{ tr.remove(); refreshPreview(); });
  }

  // initial rows
  addItem('Conception de site web - 1 page', 'Mise en place et design de la page d’accueil', 1, 1200);
  addItem('Optimisation Google My Business', 'Configuration, amélioration de la fiche et conseils de visibilité locale', 1, 600);

  addItemBtn.addEventListener('click',()=>addItem('Nouveau service','',1,0));
  previewBtn.addEventListener('click', refreshPreview);
  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Effacer tous les champs et toutes les lignes ?')) return;
    bizName.value='';bizAddress.value='';bizContact.value='';
    clientName.value='';clientAddress.value='';
    invoiceNumber.value='';taxPct.value=0;discount.value=0;
    itemsBody.innerHTML='';
    previewItemsBody.innerHTML='';
    totalsArea.innerHTML='';
    logoPreview.src='';logoPreview.classList.add('hidden');
  });

  // mirror inputs to preview
  [bizName,bizAddress,bizContact,clientName,clientAddress,invoiceNumber,invoiceDate,taxPct,discount].forEach(inp=>{
    inp.addEventListener('input', refreshPreview);
  });

  logoInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(){ logoPreview.src = reader.result; logoPreview.classList.remove('hidden'); refreshPreview(); }
    reader.readAsDataURL(f);
  });

  function getItems(){
    const rows = Array.from(itemsBody.querySelectorAll('tr'));
    return rows.map(r=>{
      return {
        desc: r.querySelector('.item-desc') ? (r.querySelector('.item-desc').value||'') : '',
        notes: r.querySelector('.item-notes') ? (r.querySelector('.item-notes').value||'') : '',
        qty: Number(r.querySelector('.item-qty').value||0),
        unit: Number(r.querySelector('.item-unit').value||0)
      };
    });
  }

  function refreshPreview(){
    // mirror texts
    bizNamePreview.textContent = bizName.value || '—';
    bizAddressPreview.textContent = bizAddress.value || '';
    bizContactPreview.textContent = bizContact.value || '';
    clientNamePreview.textContent = clientName.value || '—';
    clientAddressPreview.textContent = clientAddress.value || '';
    invNumberPreview.textContent = invoiceNumber.value || '—';
    invDatePreview.textContent = invoiceDate.value || '';

    // items
    const items = getItems();
    previewItemsBody.innerHTML='';
    let subtotal = 0;
    items.forEach((it)=>{
      const row = document.createElement('tr');
      const amount = it.qty * it.unit;
      subtotal += amount;

      const descText = escapeHtml(it.desc || '');
      const notesText = it.notes
        ? `<div class="small" style="color:#6b7280">${escapeHtml(it.notes)}</div>`
        : '';

      row.innerHTML = `
        <td>${descText}${notesText}</td>
        <td>${it.qty}</td>
        <td>${fmt(it.unit)}</td>
        <td class="text-right">${fmt(amount)}</td>
      `;
      previewItemsBody.appendChild(row);
    });

    const tax = Number(taxPct.value||0);
    const discountVal = Number(discount.value||0);
    const taxAmount = subtotal * (tax/100);
    const total = subtotal + taxAmount - discountVal;

    totalsArea.innerHTML = `
      <div style="max-width:360px;margin-left:auto">
        <div class="totals-row"><div class="small">Sous-total</div><div class="text-right">${fmt(subtotal)}</div></div>
        <div class="totals-row"><div class="small">TVA (${fmt(tax)}%)</div><div class="text-right">${fmt(taxAmount)}</div></div>
        <div class="totals-row"><div class="small">Remise</div><div class="text-right">-${fmt(discountVal)}</div></div>
        <hr style="border:none;border-top:1px solid #f0f2f7"/>
        <div class="totals-row" style="font-weight:700;font-size:16px"><div>Total</div><div class="text-right">${fmt(total)}</div></div>
      </div>
    `;
  }

  // PDF generation using html2pdf (client-side). We'll load from CDN dynamically.
  function loadHtml2pdf(){
    return new Promise((resolve,reject)=>{
      if(window.html2pdf) return resolve(window.html2pdf);
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
      s.onload = ()=>resolve(window.html2pdf);
      s.onerror = ()=>reject(new Error('Échec du chargement de html2pdf'));
      document.head.appendChild(s);
    });
  }

  generateBtn.addEventListener('click', async ()=>{
    refreshPreview();
    // ensure there's at least one item
    const items = getItems();
    if(items.length === 0){
      alert('Ajoutez au moins une ligne de facture.');
      return;
    }

    try{
      await loadHtml2pdf();
    }catch(e){
      alert('Impossible de charger la bibliothèque PDF. Vérifiez votre connexion internet.');
      return;
    }

    // Clone the invoice area and make a print-optimized version
    const clone = invoiceArea.cloneNode(true);
    // strip buttons if any and set clean styles
    clone.style.width = '210mm'; // A4 width
    clone.style.boxShadow = 'none';
    clone.style.margin = '10mm';
    clone.querySelectorAll('.btn').forEach(n=>n.remove());
    // Use html2pdf
    const opt = {
      margin: [10,10,10,10],
      filename: (invoiceNumber.value || 'facture') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    // Create a temporary container
    const wrapper = document.createElement('div');
    wrapper.style.background = '#fff';
    wrapper.appendChild(clone);
    document.body.appendChild(wrapper);
    try{
      await window.html2pdf().set(opt).from(wrapper).save();
    }catch(err){
      console.error(err);
      alert('La génération du PDF a échoué.');
    }finally{
      wrapper.remove();
    }
  });

  // keep preview reactive
  setInterval(refreshPreview, 1200);

  // ensure preview initially correct
  refreshPreview();

</script>
</body>
</html>
