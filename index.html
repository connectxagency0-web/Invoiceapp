<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G√©n√©rateur de devis ‚Äì NUVANE & COMPANY</title>
  <style>
    :root{
      --accent-start:#ff6b00;
      --accent-end:#ffb000;
      --bg:#020617;
      --card:#020617;
      --card-border:#1f2937;
      --text-main:#f9fafb;
      --text-muted:#d1d5db;
      --line:#111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    *{box-sizing:border-box;}

    body{
      margin:0;
      background:#020617 !important;
      color:var(--text-main);
      min-height:100vh;
    }

    .container{
      max-width:900px;
      margin:24px auto 40px;
      padding:0 16px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .panel{
      background:var(--card);
      border-radius:18px;
      padding:18px 16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.75);
      border:1px solid var(--card-border);
      backdrop-filter:blur(18px);
    }

    h2{
      margin:0 0 12px;
      font-size:18px;
      color:var(--text-main);
      letter-spacing:0.03em;
    }

    label{
      display:block;
      font-size:13px;
      color:var(--text-muted);
      margin:10px 0 6px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea,
    select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #374151;
      font-size:14px;
      background:#020617;
      color:var(--text-main);
      outline:none;
      transition:border 0.15s, box-shadow 0.15s, background 0.15s;
      line-height:1.4;
    }
    input::placeholder,
    textarea::placeholder{
      color:#6b7280;
    }
    input:focus,
    textarea:focus{
      border-color:var(--accent-end);
      box-shadow:0 0 0 1px rgba(251,191,36,0.6);
      background:#020617;
    }
    textarea{resize:vertical;}

    .btn{
      display:inline-block;
      padding:9px 14px;
      border-radius:999px;
      border:0;
      background:linear-gradient(135deg,var(--accent-start),var(--accent-end));
      color:#111827;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      box-shadow:0 8px 20px rgba(251,191,36,0.45);
      transition:transform 0.08s, box-shadow 0.08s, filter 0.08s;
      white-space:nowrap;
    }
    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.05);
      box-shadow:0 12px 28px rgba(251,191,36,0.55);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 4px 12px rgba(15,23,42,0.7);
    }

    .muted{color:var(--text-muted);font-size:13px}

    .line-items{
      margin-top:12px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid #1f2937;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      padding:11px 10px;
      text-align:left;
      vertical-align:top;
    }
    th{
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#111827;
      font-weight:700;
      border-bottom:1px solid #111827;
    }
    td{
      background:#020617;
      color:var(--text-main);
      border-bottom:1px solid #111827;
    }
    tr:last-child td{border-bottom:none;}

    .text-right{text-align:right;}

    .invoice-preview{padding:10px 4px;}

    .invoice-card{
      background:#020617;
      padding:24px 26px;
      border-radius:22px;
      box-shadow:0 22px 60px rgba(0,0,0,0.9);
      border:1px solid #1f2937;
      max-width:100%;
      margin:0 auto;
    }

    .flex{display:flex;gap:12px;align-items:center;}
    .spacer{flex:1;}

    .logo{
      height:108px;
      object-fit:contain;
    }

    .small{font-size:13px;color:var(--text-muted);}

    .totals{margin-top:16px;}
    .totals-row{display:flex;justify-content:space-between;padding:4px 0;}

    .actions{
      margin-top:12px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .danger{
      background:#ef4444;
      color:#fef2f2;
      box-shadow:0 8px 20px rgba(248,113,113,0.55);
    }
    .danger:hover{
      filter:brightness(1.05);
      box-shadow:0 10px 26px rgba(248,113,113,0.7);
    }

    .delete-btn{
      padding:4px 10px;
      border-radius:999px;
      border:none;
      background:#7f1d1d;
      color:#fecaca;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .delete-btn:hover{
      background:#b91c1c;
      color:#fee2e2;
    }

    .hidden{display:none;}
  </style>
</head>
<body>
  <div class="container">
    <!-- PANEL HAUT : INPUTS -->
    <div class="panel">
      <h2>Param√®tres du devis</h2>

      <label>Nom de l'entreprise</label>
      <input id="bizName" type="text" value="NUVANE &amp; COMPANY"/>

      <label>Adresse de l'entreprise</label>
      <textarea id="bizAddress">5 RUE DARAA RES FATIMA ZAHRA APPT 5
AGDAL RABAT</textarea>

      <label>T√©l√©phone / e-mail de l'entreprise</label>
      <input id="bizContact" type="text" value="+212620908676"/>

      <label>T√©l√©verser un logo (optionnel)</label>
      <input id="logoInput" type="file" accept="image/*"/>
      <div class="small muted">Un logo par d√©faut est charg√©. T√©l√©versez un fichier pour le remplacer.</div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #1f2937"/>

      <label>Nom du client</label>
      <input id="clientName" type="text" value="Nom du client"/>

      <label>Adresse du client</label>
      <textarea id="clientAddress">Adresse du client</textarea>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>N¬∞ de devis</label>
          <input id="invoiceNumber" type="text" value="DEV-2025-001"/>
        </div>
        <div style="width:150px">
          <label>Date du devis</label>
          <input id="invoiceDate" type="date" />
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #1f2937"/>

      <h3 class="small" style="margin:8px 0 6px">Lignes du devis</h3>
      <div class="line-items panel" style="padding:0">
        <table id="itemsTable">
          <thead>
            <tr>
              <th style="width:24%">Service</th>
              <th style="width:38%">Description d√©taill√©e</th>
              <th style="width:10%">Qt√©</th>
              <th style="width:16%">Prix unitaire</th>
              <th style="width:8%">Total</th>
              <th style="width:4%"></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>
      <div style="margin-top:8px">
        <button id="addItemBtn" class="btn">+ Ajouter une ligne de service</button>
      </div>

      <label style="margin-top:12px">TVA (%)</label>
      <input id="taxPct" type="number" value="20" min="0"/>

      <label>Remise (montant fixe)</label>
      <input id="discount" type="number" value="0" min="0"/>

      <div class="actions">
        <button id="generateBtn" class="btn">G√©n√©rer le PDF</button>
        <button id="previewBtn" class="btn" style="background:linear-gradient(135deg,#22c55e,#a3e635);box-shadow:0 8px 20px rgba(34,197,94,0.45);">Actualiser l'aper√ßu</button>
        <button id="clearBtn" class="btn danger">Effacer</button>
      </div>

      <div style="margin-top:12px" class="small muted">
        Ajoutez vos services manuellement, vous pouvez copier/coller et aller √† la ligne (Entr√©e) dans les champs de texte, puis g√©n√©rez le PDF.
      </div>
    </div>

    <!-- PANEL BAS : APER√áU -->
    <div class="panel invoice-preview">
      <div class="invoice-card" id="invoiceArea">
        <div class="flex">
          <div>
            <img id="logoPreview" class="logo" src="https://i.imgur.com/G1lFjjM.png" alt="NUVANE &amp; COMPANY" />
            <div style="margin-top:8px">
              <div id="bizNamePreview" style="font-weight:700;font-size:20px;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-main)">NUVANE &amp; COMPANY</div>
              <div id="bizAddressPreview" class="small">5 RUE DARAA RES FATIMA ZAHRA APPT 5 ‚Äì AGDAL RABAT</div>
              <div id="bizContactPreview" class="small">+212620908676</div>
              <div class="small" style="margin-top:4px;color:#fbbf24">The psychology of growth</div>
            </div>
          </div>
          <div class="spacer"></div>
          <div style="text-align:right">
            <div style="font-weight:800;font-size:22px;color:#facc15;letter-spacing:0.08em;">DEVIS</div>
            <div class="small">N¬∞ <span id="invNumberPreview">DEV-2025-001</span></div>
            <div class="small">Date : <span id="invDatePreview"></span></div>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #1f2937"/>

        <div style="display:flex;gap:20px">
          <div style="flex:1">
            <div class="small" style="text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted)">Devis pour</div>
            <div id="clientNamePreview" style="font-weight:600;font-size:15px;margin-top:2px;color:var(--text-main)">Nom du client</div>
            <div id="clientAddressPreview" class="small">Adresse du client</div>
          </div>
          <div style="width:220px;text-align:right">
            <div class="small">Validit√© du devis</div>
            <div class="small">Offre valable 30 jours</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <table id="previewItems">
            <thead>
              <tr><th style="width:56%">Description</th><th>Qt√©</th><th>PU</th><th class="text-right">Montant</th></tr>
            </thead>
            <tbody id="previewItemsBody"></tbody>
          </table>
        </div>

        <div class="totals" id="totalsArea"></div>

        <div style="margin-top:18px" class="small muted">
          Ce devis ne vaut pas facture. Les prestations seront r√©alis√©es apr√®s acceptation du devis.<br/>
          Pour accepter ce devis, merci de nous le confirmer par e-mail ou signature.<br/>
          NUVANE &amp; COMPANY ‚Äì The psychology of growth.
        </div>
      </div>
    </div>
  </div>

<script>
  const itemsBody = document.getElementById('itemsBody');
  const previewItemsBody = document.getElementById('previewItemsBody');
  const addItemBtn = document.getElementById('addItemBtn');
  const generateBtn = document.getElementById('generateBtn');
  const previewBtn = document.getElementById('previewBtn');
  const clearBtn = document.getElementById('clearBtn');

  const bizName = document.getElementById('bizName');
  const bizAddress = document.getElementById('bizAddress');
  const bizContact = document.getElementById('bizContact');
  const clientName = document.getElementById('clientName');
  const clientAddress = document.getElementById('clientAddress');
  const invoiceNumber = document.getElementById('invoiceNumber');
  const invoiceDate = document.getElementById('invoiceDate');
  const taxPct = document.getElementById('taxPct');
  const discount = document.getElementById('discount');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');

  const bizNamePreview = document.getElementById('bizNamePreview');
  const bizAddressPreview = document.getElementById('bizAddressPreview');
  const bizContactPreview = document.getElementById('bizContactPreview');
  const clientNamePreview = document.getElementById('clientNamePreview');
  const clientAddressPreview = document.getElementById('clientAddressPreview');
  const invNumberPreview = document.getElementById('invNumberPreview');
  const invDatePreview = document.getElementById('invDatePreview');
  const totalsArea = document.getElementById('totalsArea');
  const invoiceArea = document.getElementById('invoiceArea');

  (function setToday(){
    const today = new Date().toISOString().slice(0,10);
    invoiceDate.value = today;
  })();

  function fmt(n){
    return Number(n || 0).toLocaleString(undefined, {
      minimumFractionDigits:2,
      maximumFractionDigits:2
    });
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function escapeHtmlWithBreaks(s){
    return escapeHtml(s).replace(/\n/g,'<br>');
  }

  function addItem(desc='', notes='', qty=1, unit=0){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <textarea class="item-desc" rows="1" placeholder="Nom du service (copier/coller possible)">${escapeHtml(desc)}</textarea>
      </td>
      <td>
        <textarea class="item-notes" rows="2" placeholder="Description d√©taill√©e (Entr√©e pour aller √† la ligne)">${escapeHtml(notes)}</textarea>
      </td>
      <td><input class="item-qty" type="number" value="${qty}" min="0" /></td>
      <td><input class="item-unit" type="number" value="${unit}" min="0" step="0.01" /></td>
      <td class="text-right item-total">${fmt(qty*unit)}</td>
      <td style="text-align:center">
        <button class="delete-btn removeBtn" title="Supprimer cette ligne">
          üóë Supprimer
        </button>
      </td>
    `;
    itemsBody.appendChild(tr);
    bindRowEvents(tr);
    refreshPreview();
  }

  function bindRowEvents(tr){
    const desc = tr.querySelector('.item-desc');
    const notes = tr.querySelector('.item-notes');
    const qty = tr.querySelector('.item-qty');
    const unit = tr.querySelector('.item-unit');
    const totalCell = tr.querySelector('.item-total');
    const removeBtn = tr.querySelector('.removeBtn');

    function updateRow(){
      const q = Number(qty.value||0);
      const u = Number(unit.value||0);
      totalCell.textContent = fmt(q*u);
      refreshPreview();
    }
    desc.addEventListener('input', refreshPreview);
    if(notes){ notes.addEventListener('input', refreshPreview); }
    qty.addEventListener('input', updateRow);
    unit.addEventListener('input', updateRow);
    removeBtn.addEventListener('click', ()=>{
      tr.remove();
      refreshPreview();
    });
  }

  // Pas de lignes par d√©faut : l'utilisateur ajoute manuellement
  addItemBtn.addEventListener('click',()=>addItem('', '', 1, 0));
  previewBtn.addEventListener('click', refreshPreview);

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Effacer tous les champs et toutes les lignes du devis ?')) return;
    bizName.value='NUVANE & COMPANY';
    bizAddress.value='5 RUE DARAA RES FATIMA ZAHRA APPT 5\nAGDAL RABAT';
    bizContact.value='+212620908676';
    clientName.value='';
    clientAddress.value='';
    invoiceNumber.value='';
    taxPct.value=0;
    discount.value=0;
    itemsBody.innerHTML='';
    previewItemsBody.innerHTML='';
    totalsArea.innerHTML='';
    logoPreview.src='https://i.imgur.com/G1lFjjM.png';
    const today = new Date().toISOString().slice(0,10);
    invoiceDate.value = today;
    refreshPreview();
  });

  [bizName,bizAddress,bizContact,clientName,clientAddress,invoiceNumber,invoiceDate,taxPct,discount].forEach(inp=>{
    inp.addEventListener('input', refreshPreview);
  });

  logoInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(){
      logoPreview.src = reader.result;
      refreshPreview();
    };
    reader.readAsDataURL(f);
  });

  function getItems(){
    return Array.from(itemsBody.querySelectorAll('tr')).map(r=>({
      desc: r.querySelector('.item-desc')?.value || '',
      notes: r.querySelector('.item-notes')?.value || '',
      qty: Number(r.querySelector('.item-qty')?.value || 0),
      unit: Number(r.querySelector('.item-unit')?.value || 0)
    }));
  }

  function refreshPreview(){
    bizNamePreview.textContent = bizName.value || '‚Äî';
    bizAddressPreview.textContent = (bizAddress.value || '').replace(/\n/g,' ‚Äì ');
    bizContactPreview.textContent = bizContact.value || '';
    clientNamePreview.textContent = clientName.value || '‚Äî';
    clientAddressPreview.textContent = clientAddress.value || '';
    invNumberPreview.textContent = invoiceNumber.value || '‚Äî';
    invDatePreview.textContent = invoiceDate.value || '';

    const items = getItems();
    previewItemsBody.innerHTML='';
    let subtotal = 0;

    items.forEach(it=>{
      const row = document.createElement('tr');
      const amount = it.qty * it.unit;
      subtotal += amount;

      const serviceHtml = it.desc
        ? `<strong>${escapeHtmlWithBreaks(it.desc)}</strong>` 
        : '';
      const notesHtml = it.notes
        ? `<div class="small" style="color:#e5e7eb;margin-top:2px">${escapeHtmlWithBreaks(it.notes)}</div>` 
        : '';

      row.innerHTML = `
        <td>${serviceHtml}${notesHtml}</td>
        <td>${it.qty}</td>
        <td>${fmt(it.unit)}</td>
        <td class="text-right">${fmt(amount)}</td>
      `;
      previewItemsBody.appendChild(row);
    });

    const tax = Number(taxPct.value||0);
    const discountVal = Number(discount.value||0);
    const taxAmount = subtotal * (tax/100);
    const total = subtotal + taxAmount - discountVal;

    totalsArea.innerHTML = `
      <div style="max-width:360px;margin-left:auto;margin-top:10px;background:#020617;border-radius:14px;padding:12px 14px;border:1px solid #1f2937">
        <div class="totals-row"><div class="small">Sous-total</div><div class="text-right">${fmt(subtotal)}</div></div>
        <div class="totals-row"><div class="small">TVA (${fmt(tax)}%)</div><div class="text-right">${fmt(taxAmount)}</div></div>
        <div class="totals-row"><div class="small">Remise</div><div class="text-right">-${fmt(discountVal)}</div></div>
        <hr style="border:none;border-top:1px solid #1f2937;margin-top:6px;margin-bottom:6px"/>
        <div class="totals-row" style="font-weight:700;font-size:16px;color:#fbbf24">
          <div>Total</div><div class="text-right">${fmt(total)}</div>
        </div>
      </div>
    `;
  }

  function loadHtml2pdf(){
    return new Promise((resolve,reject)=>{
      if(window.html2pdf) return resolve(window.html2pdf);
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
      s.onload = ()=>resolve(window.html2pdf);
      s.onerror = ()=>reject(new Error('√âchec du chargement de html2pdf'));
      document.head.appendChild(s);
    });
  }

  generateBtn.addEventListener('click', async ()=>{
    refreshPreview();
    const items = getItems();
    if(items.length === 0){
      alert('Ajoutez au moins un service dans le devis.');
      return;
    }

    try{
      await loadHtml2pdf();
    }catch(e){
      alert('Impossible de charger la biblioth√®que PDF. V√©rifiez votre connexion internet.');
      return;
    }

    const clone = invoiceArea.cloneNode(true);
    clone.style.width = '190mm';
    clone.style.maxWidth = '190mm';
    clone.style.margin = '0';
    clone.style.borderRadius = '0';
    clone.style.border = 'none';
    clone.style.boxShadow = 'none';
    clone.style.background = '#020617';
    clone.style.padding = '10mm';
    clone.style.color = '#f9fafb';

    clone.querySelectorAll('table').forEach(t => {
      t.style.width = '100%';
      t.querySelectorAll('th').forEach(th=>{
        th.style.background = 'linear-gradient(135deg,#f97316,#facc15)';
        th.style.color = '#111827';
        th.style.borderBottom = '1px solid #111827';
      });
      t.querySelectorAll('td').forEach(td=>{
        td.style.background = '#020617';
        td.style.color = '#f9fafb';
        td.style.borderBottom = '1px solid #111827';
      });
    });

    const opt = {
      margin: [0,0,0,0],
      filename: (invoiceNumber.value || 'devis') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: '#020617' },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    const wrapper = document.createElement('div');
    wrapper.style.background = '#020617';
    wrapper.style.width = '210mm';
    wrapper.style.padding = '0';
    wrapper.appendChild(clone);

    document.body.appendChild(wrapper);
    try{
      await window.html2pdf().set(opt).from(wrapper).save();
    }catch(err){
      console.error(err);
      alert('La g√©n√©ration du PDF a √©chou√©.');
    }finally{
      wrapper.remove();
    }
  });

  setInterval(refreshPreview, 1200);
  refreshPreview();
</script>
</body>
</html>
